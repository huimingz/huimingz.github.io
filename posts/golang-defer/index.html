<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Golang defer知识点" /><meta name="author" content="huimingz" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="defer的特性：" /><meta property="og:description" content="defer的特性：" /><link rel="canonical" href="http://blog.huimingz.com/posts/golang-defer/" /><meta property="og:url" content="http://blog.huimingz.com/posts/golang-defer/" /><meta property="og:site_name" content="Ming" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-13T16:38:42+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Golang defer知识点" /><meta name="twitter:site" content="@huimingz12" /><meta name="twitter:creator" content="@huimingz" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"huimingz"},"description":"defer的特性：","headline":"Golang defer知识点","dateModified":"2021-02-13T16:38:42+08:00","datePublished":"2021-02-13T16:38:42+08:00","url":"http://blog.huimingz.com/posts/golang-defer/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://blog.huimingz.com/posts/golang-defer/"},"@context":"https://schema.org"}</script><title>Golang defer知识点 | Ming</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-40NBME9NKT"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-40NBME9NKT'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://hmz-storage.oss-cn-shenzhen.aliyuncs.com/static/img/2021/10-02-2cbb4cf1fbdce6867de9f0fe1ca97d5d.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ming</a></div><div class="site-subtitle font-italic">努力的人总会发光的吧</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/huimingz" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/huimingz12" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['huimingz12','outlook.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Golang defer知识点</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Golang defer知识点</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Feb 13, 2021, 4:38 PM +0800" > Feb 13, 2021 <i class="unloaded">2021-02-13T16:38:42+08:00</i> </span> by <span class="author"> huimingz </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3020 words">16 min</span></div></div><div class="post-content"><p><code class="language-plaintext highlighter-rouge">defer</code>的特性：</p><ol><li><code class="language-plaintext highlighter-rouge">defer</code>在函数执行<code class="language-plaintext highlighter-rouge">return</code>或者<code class="language-plaintext highlighter-rouge">panic</code>之后执行，多个<code class="language-plaintext highlighter-rouge">defer</code>的执行顺序为“先进后出（FILO）”。<li>匿名返回值在<code class="language-plaintext highlighter-rouge">return</code>执行时被声明；有名返回值则是在声明的同时被声明。<code class="language-plaintext highlighter-rouge">defer</code>语句只能访问有名返回值，不能直接访问匿名返回值。<li><code class="language-plaintext highlighter-rouge">defer</code>、<code class="language-plaintext highlighter-rouge">return</code>和返回值的执行逻辑：<code class="language-plaintext highlighter-rouge">return</code>先执行，<code class="language-plaintext highlighter-rouge">return</code>将结果写入到返回值中；然后<code class="language-plaintext highlighter-rouge">defer</code>开始执行一些收尾工作；最后<code class="language-plaintext highlighter-rouge">RET</code>（汇编命令，用于结束一个函数）携带返回值退出函数。<li>主动调用<code class="language-plaintext highlighter-rouge">os.Exit(int)</code>退出进程时，已声明的defer将不再被执行。<li><code class="language-plaintext highlighter-rouge">defer</code>声明时会先计算确定参数的值，<code class="language-plaintext highlighter-rouge">defer</code>推迟执行的是其函数体。<li><code class="language-plaintext highlighter-rouge">defer</code>的作用域：<ul><li>只对当前goroutine有效；<li>当<code class="language-plaintext highlighter-rouge">panic</code>发生时仍然会执行当前goroutine中已声明的<code class="language-plaintext highlighter-rouge">defer</code>语句，如果未遇到<code class="language-plaintext highlighter-rouge">recover()</code>则会执行完所有的<code class="language-plaintext highlighter-rouge">defer</code>后引发<strong>整个进程的崩溃</strong>。</ul></ol><p><code class="language-plaintext highlighter-rouge">return</code>执行步骤：</p><ol><li>给返回值赋值（若为有名返回值则直接赋值，若为匿名返回值则先声明再赋值）。<li>调用RET返回指令并传入返回值，而RET则会检查defer是否存在，若存在就先逆序插播defer语句，最后RET携带返回值退出函数。</ol><p>※ Golang不同于C语言，被调用函数的入参和返回值由调用者函数维护，这也就是为什么Golang支持多返回值的原因。</p><h2 id="执行顺序">执行顺序</h2><p>先进后出原则，可以看作是一个“栈”的结构关系。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/2021/02-13-golang-defer-sequence.png" alt="流程图" /></p><h2 id="defer中出现panic时">defer中出现panic时</h2><p>在<code class="language-plaintext highlighter-rouge">defer</code>语句中执行<code class="language-plaintext highlighter-rouge">panic</code>和在外面执行效果时一样的，可以被位于其之后的<code class="language-plaintext highlighter-rouge">recover()</code>所捕获。</p><div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">doo</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"execute the doo function."</span><span class="p">)</span>

	<span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">v</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="n">v</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"recover v: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}()</span>

	<span class="k">defer</span> <span class="k">func</span><span class="p">(</span><span class="n">t</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"time: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
	<span class="p">}(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>

	<span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"doo.defer()"</span><span class="p">)</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">"yahoo!!!!!"</span><span class="p">)</span>
	<span class="p">}()</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="k">go</span> <span class="n">doo</span><span class="p">()</span>

	<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
	<span class="nb">println</span><span class="p">(</span><span class="s">"end of main function."</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>执行结果:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>$ go run p.go execute the doo function.
doo.defer()
time: 2021-02-13 17:12:41.355246 +0800 CST m=+0.000121017
recover v: yahoo!!!!!
end of main function.
</pre></table></code></div></div><h2 id="有名返回值和匿名返回值遇见defer">有名返回值和匿名返回值遇见defer</h2><p><code class="language-plaintext highlighter-rouge">defer</code>声明的语句中是无法访问匿名返回值的，而匿名返回值的声明是在<code class="language-plaintext highlighter-rouge">return</code>语句执行的时候声明的（匿名返回值的情况时）。</p><p>示例代码：</p><div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">func</span> <span class="n">a</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">var</span> <span class="n">i</span> <span class="kt">int</span>
	<span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span>
		<span class="nb">println</span><span class="p">(</span><span class="s">"a defer: i ="</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
	<span class="p">}()</span>
	<span class="n">i</span> <span class="o">=</span> <span class="m">100</span>
	<span class="k">return</span> <span class="n">i</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">b</span><span class="p">()</span> <span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span>
		<span class="nb">println</span><span class="p">(</span><span class="s">"b defer: i ="</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
	<span class="p">}()</span>
	<span class="n">i</span> <span class="o">=</span> <span class="m">100</span>
	<span class="k">return</span> <span class="n">i</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nb">println</span><span class="p">(</span><span class="s">"a return:"</span><span class="p">,</span> <span class="n">a</span><span class="p">())</span>
	<span class="nb">println</span><span class="p">(</span><span class="s">"b return:"</span><span class="p">,</span> <span class="n">b</span><span class="p">())</span>
<span class="p">}</span>
</pre></table></code></div></div><p>输出:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>$ go run main_a.go
a defer: i = 101
a return: 100
b defer: i = 101
b return: 101
</pre></table></code></div></div><p>从结果中可以发现b函数的<code class="language-plaintext highlighter-rouge">defer</code>语句修改了返回的值，这是因为返回值一开始就被声明了，<code class="language-plaintext highlighter-rouge">return</code>语句执行将执行结果进行了赋值操作。</p><p>而a函数的<code class="language-plaintext highlighter-rouge">defer</code>虽然执行了，但是并没有修改函数最终的返回值，其原因就如最初所说的那样，匿名返回值类型是在<code class="language-plaintext highlighter-rouge">return</code>语句执行时声明的，a函数内最初声明<code class="language-plaintext highlighter-rouge">var i int</code>只是声明了一个函数内的局部变量，他只是存活于当前函数作用域内，与返回值并没有直接关系。</p><p>从汇编的角度来分析一下执行过程：</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># 获取汇编代码</span>
go build <span class="nt">-gcflags</span> <span class="s2">"-N -l"</span> main_a.go
</pre></table></code></div></div><p>汇编代码（删除了很多无用的输出）：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
</pre><td class="rouge-code"><pre>"".a STEXT size=161 args=0x8 locals=0x68  ;; A函数
        0x0000 00000 (main_a.go:3)      TEXT    "".a(SB), ABIInternal, $104-8
        0x0000 00000 (main_a.go:3)      MOVQ    (TLS), CX
        0x0009 00009 (main_a.go:3)      CMPQ    SP, 16(CX)
        0x000d 00013 (main_a.go:3)      PCDATA  $0, $-2
        0x000d 00013 (main_a.go:3)      JLS     151
        0x0013 00019 (main_a.go:3)      PCDATA  $0, $-1
        0x0013 00019 (main_a.go:3)      SUBQ    $104, SP
        0x0017 00023 (main_a.go:3)      MOVQ    BP, 96(SP)
        0x001c 00028 (main_a.go:3)      LEAQ    96(SP), BP
        0x0021 00033 (main_a.go:3)      PCDATA  $0, $-2
        0x0021 00033 (main_a.go:3)      PCDATA  $1, $-2
        0x0021 00033 (main_a.go:3)      FUNCDATA        $0, gclocals·33cdeccccebe80329f1fdbee7f5874cb(SB)
        0x0021 00033 (main_a.go:3)      FUNCDATA        $1, gclocals·33cdeccccebe80329f1fdbee7f5874cb(SB)
        0x0021 00033 (main_a.go:3)      FUNCDATA        $2, gclocals·9fb7f0986f647f17cb53dda1484e0f7a(SB)
        0x0021 00033 (main_a.go:3)      PCDATA  $0, $0
        0x0021 00033 (main_a.go:3)      PCDATA  $1, $0
        0x0021 00033 (main_a.go:3)      MOVQ    $0, "".~r0+112(SP)  ;; 返回值初始化
        0x002a 00042 (main_a.go:4)      MOVQ    $0, "".i+8(SP)      ;; 局部变量i的初始化
        0x0033 00051 (main_a.go:5)      MOVL    $8, ""..autotmp_3+16(SP)
        0x003b 00059 (main_a.go:5)      PCDATA  $0, $1
        0x003b 00059 (main_a.go:5)      LEAQ    "".a.func1·f(SB), AX  ;; 将defer函数地址存储于‘临时内存区域’
        0x0042 00066 (main_a.go:5)      PCDATA  $0, $0
        0x0042 00066 (main_a.go:5)      MOVQ    AX, ""..autotmp_3+40(SP)
        0x0047 00071 (main_a.go:5)      PCDATA  $0, $1
        0x0047 00071 (main_a.go:5)      LEAQ    "".i+8(SP), AX
        0x004c 00076 (main_a.go:5)      PCDATA  $0, $0
        0x004c 00076 (main_a.go:5)      MOVQ    AX, ""..autotmp_3+88(SP)
        0x0051 00081 (main_a.go:5)      PCDATA  $0, $1
        0x0051 00081 (main_a.go:5)      LEAQ    ""..autotmp_3+16(SP), AX
        0x0056 00086 (main_a.go:5)      PCDATA  $0, $0
        0x0056 00086 (main_a.go:5)      MOVQ    AX, (SP)
        0x005a 00090 (main_a.go:5)      CALL    runtime.deferprocStack(SB)
        0x005f 00095 (main_a.go:5)      TESTL   AX, AX
        0x0061 00097 (main_a.go:5)      JNE     135
        0x0063 00099 (main_a.go:5)      JMP     101
        0x0065 00101 (main_a.go:9)      MOVQ    $100, "".i+8(SP)  ;; 对局部变量i执行赋值操作
        0x006e 00110 (main_a.go:10)     MOVQ    $100, "".~r0+112(SP)  ;; 给返回值赋值
        0x0077 00119 (main_a.go:10)     XCHGL   AX, AX
        0x0078 00120 (main_a.go:10)     CALL    runtime.deferreturn(SB)
        0x007d 00125 (main_a.go:10)     MOVQ    96(SP), BP
        0x0082 00130 (main_a.go:10)     ADDQ    $104, SP
        0x0086 00134 (main_a.go:10)     RET
        0x0087 00135 (main_a.go:5)      XCHGL   AX, AX
        0x0088 00136 (main_a.go:5)      CALL    runtime.deferreturn(SB)
        0x008d 00141 (main_a.go:5)      MOVQ    96(SP), BP
        0x0092 00146 (main_a.go:5)      ADDQ    $104, SP
        0x0096 00150 (main_a.go:5)      RET
        0x0097 00151 (main_a.go:5)      NOP
        0x0097 00151 (main_a.go:3)      PCDATA  $1, $-1
        0x0097 00151 (main_a.go:3)      PCDATA  $0, $-2
        0x0097 00151 (main_a.go:3)      CALL    runtime.morestack_noctxt(SB)
        0x009c 00156 (main_a.go:3)      PCDATA  $0, $-1
        0x009c 00156 (main_a.go:3)      JMP     0
"".b STEXT size=139 args=0x8 locals=0x60
        0x0000 00000 (main_a.go:13)     TEXT    "".b(SB), ABIInternal, $96-8
        0x0000 00000 (main_a.go:13)     MOVQ    (TLS), CX
        0x0009 00009 (main_a.go:13)     CMPQ    SP, 16(CX)
        0x000d 00013 (main_a.go:13)     PCDATA  $0, $-2
        0x000d 00013 (main_a.go:13)     JLS     129
        0x000f 00015 (main_a.go:13)     PCDATA  $0, $-1
        0x000f 00015 (main_a.go:13)     SUBQ    $96, SP
        0x0013 00019 (main_a.go:13)     MOVQ    BP, 88(SP)
        0x0018 00024 (main_a.go:13)     LEAQ    88(SP), BP
        0x001d 00029 (main_a.go:13)     PCDATA  $0, $-2
        0x001d 00029 (main_a.go:13)     PCDATA  $1, $-2
        0x001d 00029 (main_a.go:13)     FUNCDATA        $0, gclocals·33cdeccccebe80329f1fdbee7f5874cb(SB)
        0x001d 00029 (main_a.go:13)     FUNCDATA        $1, gclocals·33cdeccccebe80329f1fdbee7f5874cb(SB)
        0x001d 00029 (main_a.go:13)     FUNCDATA        $2, gclocals·9fb7f0986f647f17cb53dda1484e0f7a(SB)
        0x001d 00029 (main_a.go:13)     PCDATA  $0, $0
        0x001d 00029 (main_a.go:13)     PCDATA  $1, $0
        0x001d 00029 (main_a.go:13)     MOVQ    $0, "".i+104(SP)  ;; 初始化有名返回值i，注意这里没有和a的区别
        0x0026 00038 (main_a.go:14)     MOVL    $8, ""..autotmp_2+8(SP)
        0x002e 00046 (main_a.go:14)     PCDATA  $0, $1
        0x002e 00046 (main_a.go:14)     LEAQ    "".b.func1·f(SB), AX
        0x0035 00053 (main_a.go:14)     PCDATA  $0, $0
        0x0035 00053 (main_a.go:14)     MOVQ    AX, ""..autotmp_2+32(SP)
        0x003a 00058 (main_a.go:14)     PCDATA  $0, $1
        0x003a 00058 (main_a.go:14)     LEAQ    "".i+104(SP), AX
        0x003f 00063 (main_a.go:14)     PCDATA  $0, $0
        0x003f 00063 (main_a.go:14)     MOVQ    AX, ""..autotmp_2+80(SP)
        0x0044 00068 (main_a.go:14)     PCDATA  $0, $1
        0x0044 00068 (main_a.go:14)     LEAQ    ""..autotmp_2+8(SP), AX
        0x0049 00073 (main_a.go:14)     PCDATA  $0, $0
        0x0049 00073 (main_a.go:14)     MOVQ    AX, (SP)
        0x004d 00077 (main_a.go:14)     CALL    runtime.deferprocStack(SB)
        0x0052 00082 (main_a.go:14)     TESTL   AX, AX
        0x0054 00084 (main_a.go:14)     JNE     113
        0x0056 00086 (main_a.go:14)     JMP     88
        0x0058 00088 (main_a.go:18)     MOVQ    $100, "".i+104(SP)  ;; 给i赋值100（其实就是相当于给返回值赋值100）
        0x0061 00097 (main_a.go:19)     XCHGL   AX, AX
        0x0062 00098 (main_a.go:19)     CALL    runtime.deferreturn(SB)
        0x0067 00103 (main_a.go:19)     MOVQ    88(SP), BP
        0x006c 00108 (main_a.go:19)     ADDQ    $96, SP
        0x0070 00112 (main_a.go:19)     RET
        0x0071 00113 (main_a.go:14)     XCHGL   AX, AX
        0x0072 00114 (main_a.go:14)     CALL    runtime.deferreturn(SB)
        0x0077 00119 (main_a.go:14)     MOVQ    88(SP), BP
        0x007c 00124 (main_a.go:14)     ADDQ    $96, SP
        0x0080 00128 (main_a.go:14)     RET
        0x0081 00129 (main_a.go:14)     NOP
        0x0081 00129 (main_a.go:13)     PCDATA  $1, $-1
        0x0081 00129 (main_a.go:13)     PCDATA  $0, $-2
        0x0081 00129 (main_a.go:13)     CALL    runtime.morestack_noctxt(SB)
        0x0086 00134 (main_a.go:13)     PCDATA  $0, $-1
        0x0086 00134 (main_a.go:13)     JMP     0
"".main STEXT size=189 args=0x0 locals=0x20  ;; 主函数main
        0x0000 00000 (main_a.go:22)     TEXT    "".main(SB), ABIInternal, $32-0
        0x0000 00000 (main_a.go:22)     MOVQ    (TLS), CX
        0x0009 00009 (main_a.go:22)     CMPQ    SP, 16(CX)
        0x000d 00013 (main_a.go:22)     PCDATA  $0, $-2
        0x000d 00013 (main_a.go:22)     JLS     179
        0x0013 00019 (main_a.go:22)     PCDATA  $0, $-1
        0x0013 00019 (main_a.go:22)     SUBQ    $32, SP
        0x0017 00023 (main_a.go:22)     MOVQ    BP, 24(SP)
        0x001c 00028 (main_a.go:22)     LEAQ    24(SP), BP
        0x0021 00033 (main_a.go:22)     PCDATA  $0, $-2
        0x0021 00033 (main_a.go:22)     PCDATA  $1, $-2
        0x0021 00033 (main_a.go:22)     FUNCDATA        $0, gclocals·33cdeccccebe80329f1fdbee7f5874cb(SB)
        0x0021 00033 (main_a.go:22)     FUNCDATA        $1, gclocals·33cdeccccebe80329f1fdbee7f5874cb(SB)
        0x0021 00033 (main_a.go:22)     FUNCDATA        $2, gclocals·9fb7f0986f647f17cb53dda1484e0f7a(SB)
        0x0021 00033 (main_a.go:23)     PCDATA  $0, $0
        0x0021 00033 (main_a.go:23)     PCDATA  $1, $0
        0x0021 00033 (main_a.go:23)     CALL    "".a(SB)
        0x0026 00038 (main_a.go:23)     MOVQ    (SP), AX
        0x002a 00042 (main_a.go:23)     MOVQ    AX, ""..autotmp_0+16(SP)
        0x002f 00047 (main_a.go:23)     CALL    runtime.printlock(SB)
        0x0034 00052 (main_a.go:23)     PCDATA  $0, $1
        0x0034 00052 (main_a.go:23)     LEAQ    go.string."a return: "(SB), AX
        0x003b 00059 (main_a.go:23)     PCDATA  $0, $0
        0x003b 00059 (main_a.go:23)     MOVQ    AX, (SP)
        0x003f 00063 (main_a.go:23)     MOVQ    $10, 8(SP)
        0x0048 00072 (main_a.go:23)     CALL    runtime.printstring(SB)
        0x004d 00077 (main_a.go:23)     MOVQ    ""..autotmp_0+16(SP), AX
        0x0052 00082 (main_a.go:23)     MOVQ    AX, (SP)
        0x0056 00086 (main_a.go:23)     CALL    runtime.printint(SB)
        0x005b 00091 (main_a.go:23)     CALL    runtime.printnl(SB)
        0x0060 00096 (main_a.go:23)     CALL    runtime.printunlock(SB)
        0x0065 00101 (main_a.go:24)     CALL    "".b(SB)
        0x006a 00106 (main_a.go:24)     MOVQ    (SP), AX
        0x006e 00110 (main_a.go:24)     MOVQ    AX, ""..autotmp_0+16(SP)
        0x0073 00115 (main_a.go:24)     CALL    runtime.printlock(SB)
        0x0078 00120 (main_a.go:24)     PCDATA  $0, $1
        0x0078 00120 (main_a.go:24)     LEAQ    go.string."b return: "(SB), AX
        0x007f 00127 (main_a.go:24)     PCDATA  $0, $0
        0x007f 00127 (main_a.go:24)     MOVQ    AX, (SP)
        0x0083 00131 (main_a.go:24)     MOVQ    $10, 8(SP)
        0x008c 00140 (main_a.go:24)     CALL    runtime.printstring(SB)
        0x0091 00145 (main_a.go:24)     MOVQ    ""..autotmp_0+16(SP), AX
        0x0096 00150 (main_a.go:24)     MOVQ    AX, (SP)
        0x009a 00154 (main_a.go:24)     CALL    runtime.printint(SB)
        0x009f 00159 (main_a.go:24)     CALL    runtime.printnl(SB)
        0x00a4 00164 (main_a.go:24)     CALL    runtime.printunlock(SB)
        0x00a9 00169 (main_a.go:25)     MOVQ    24(SP), BP
        0x00ae 00174 (main_a.go:25)     ADDQ    $32, SP
        0x00b2 00178 (main_a.go:25)     RET
        0x00b3 00179 (main_a.go:25)     NOP
        0x00b3 00179 (main_a.go:22)     PCDATA  $1, $-1
        0x00b3 00179 (main_a.go:22)     PCDATA  $0, $-2
        0x00b3 00179 (main_a.go:22)     CALL    runtime.morestack_noctxt(SB)
        0x00b8 00184 (main_a.go:22)     PCDATA  $0, $-1
        0x00b8 00184 (main_a.go:22)     JMP     0
"".a.func1 STEXT size=127 args=0x8 locals=0x20  ;; a函数内defer语句的函数
        0x0000 00000 (main_a.go:5)      TEXT    "".a.func1(SB), ABIInternal, $32-8
        0x0000 00000 (main_a.go:5)      MOVQ    (TLS), CX
        0x0009 00009 (main_a.go:5)      CMPQ    SP, 16(CX)
        0x000d 00013 (main_a.go:5)      PCDATA  $0, $-2
        0x000d 00013 (main_a.go:5)      JLS     120
        0x000f 00015 (main_a.go:5)      PCDATA  $0, $-1
        0x000f 00015 (main_a.go:5)      SUBQ    $32, SP
        0x0013 00019 (main_a.go:5)      MOVQ    BP, 24(SP)
        0x0018 00024 (main_a.go:5)      LEAQ    24(SP), BP
        0x001d 00029 (main_a.go:5)      PCDATA  $0, $-2
        0x001d 00029 (main_a.go:5)      PCDATA  $1, $-2
        0x001d 00029 (main_a.go:5)      FUNCDATA        $0, gclocals·1a65e721a2ccc325b382662e7ffee780(SB)
        0x001d 00029 (main_a.go:5)      FUNCDATA        $1, gclocals·69c1753bd5f81501d95132d08af04464(SB)
        0x001d 00029 (main_a.go:5)      FUNCDATA        $2, gclocals·1cf923758aae2e428391d1783fe59973(SB)
        0x001d 00029 (main_a.go:6)      PCDATA  $0, $1
        0x001d 00029 (main_a.go:6)      PCDATA  $1, $0
        0x001d 00029 (main_a.go:6)      MOVQ    "".&amp;i+40(SP), AX  ;; 获取i的值并存放到寄存器中（记住这里同样会影响外部函数作用域内i的值，但并没有影响外部的返回值，因为i并不是返回值）
        0x0022 00034 (main_a.go:6)      PCDATA  $0, $0
        0x0022 00034 (main_a.go:6)      MOVQ    (AX), AX
        0x0025 00037 (main_a.go:6)      PCDATA  $0, $2
        0x0025 00037 (main_a.go:6)      MOVQ    "".&amp;i+40(SP), CX
        0x002a 00042 (main_a.go:6)      INCQ    AX  ;; 自增1
        0x002d 00045 (main_a.go:6)      PCDATA  $0, $0
        0x002d 00045 (main_a.go:6)      MOVQ    AX, (CX)
        0x0030 00048 (main_a.go:7)      CALL    runtime.printlock(SB)
        0x0035 00053 (main_a.go:7)      PCDATA  $0, $1
        0x0035 00053 (main_a.go:7)      LEAQ    go.string."a defer: i = "(SB), AX
        0x003c 00060 (main_a.go:7)      PCDATA  $0, $0
        0x003c 00060 (main_a.go:7)      MOVQ    AX, (SP)
        0x0040 00064 (main_a.go:7)      MOVQ    $13, 8(SP)
        0x0049 00073 (main_a.go:7)      CALL    runtime.printstring(SB)
        0x004e 00078 (main_a.go:7)      PCDATA  $0, $1
        0x004e 00078 (main_a.go:7)      PCDATA  $1, $1
        0x004e 00078 (main_a.go:7)      MOVQ    "".&amp;i+40(SP), AX
        0x0053 00083 (main_a.go:7)      PCDATA  $0, $0
        0x0053 00083 (main_a.go:7)      MOVQ    (AX), AX
        0x0056 00086 (main_a.go:7)      MOVQ    AX, ""..autotmp_1+16(SP)
        0x005b 00091 (main_a.go:7)      MOVQ    AX, (SP)
        0x005f 00095 (main_a.go:7)      CALL    runtime.printint(SB)
        0x0064 00100 (main_a.go:7)      CALL    runtime.printnl(SB)
        0x0069 00105 (main_a.go:7)      CALL    runtime.printunlock(SB)
        0x006e 00110 (main_a.go:8)      MOVQ    24(SP), BP
        0x0073 00115 (main_a.go:8)      ADDQ    $32, SP
        0x0077 00119 (main_a.go:8)      RET
        0x0078 00120 (main_a.go:8)      NOP
        0x0078 00120 (main_a.go:5)      PCDATA  $1, $-1
        0x0078 00120 (main_a.go:5)      PCDATA  $0, $-2
        0x0078 00120 (main_a.go:5)      CALL    runtime.morestack_noctxt(SB)
        0x007d 00125 (main_a.go:5)      PCDATA  $0, $-1
        0x007d 00125 (main_a.go:5)      JMP     0
"".b.func1 STEXT size=127 args=0x8 locals=0x20  ;; b函数内的defer语句的函数
        0x0000 00000 (main_a.go:14)     TEXT    "".b.func1(SB), ABIInternal, $32-8
        0x0000 00000 (main_a.go:14)     MOVQ    (TLS), CX
        0x0009 00009 (main_a.go:14)     CMPQ    SP, 16(CX)
        0x000d 00013 (main_a.go:14)     PCDATA  $0, $-2
        0x000d 00013 (main_a.go:14)     JLS     120
        0x000f 00015 (main_a.go:14)     PCDATA  $0, $-1
        0x000f 00015 (main_a.go:14)     SUBQ    $32, SP
        0x0013 00019 (main_a.go:14)     MOVQ    BP, 24(SP)
        0x0018 00024 (main_a.go:14)     LEAQ    24(SP), BP
        0x001d 00029 (main_a.go:14)     PCDATA  $0, $-2
        0x001d 00029 (main_a.go:14)     PCDATA  $1, $-2
        0x001d 00029 (main_a.go:14)     FUNCDATA        $0, gclocals·1a65e721a2ccc325b382662e7ffee780(SB)
        0x001d 00029 (main_a.go:14)     FUNCDATA        $1, gclocals·69c1753bd5f81501d95132d08af04464(SB)
        0x001d 00029 (main_a.go:14)     FUNCDATA        $2, gclocals·1cf923758aae2e428391d1783fe59973(SB)
        0x001d 00029 (main_a.go:15)     PCDATA  $0, $1
        0x001d 00029 (main_a.go:15)     PCDATA  $1, $0
        0x001d 00029 (main_a.go:15)     MOVQ    "".&amp;i+40(SP), AX
        0x0022 00034 (main_a.go:15)     PCDATA  $0, $0
        0x0022 00034 (main_a.go:15)     MOVQ    (AX), AX
        0x0025 00037 (main_a.go:15)     PCDATA  $0, $2
        0x0025 00037 (main_a.go:15)     MOVQ    "".&amp;i+40(SP), CX
        0x002a 00042 (main_a.go:15)     INCQ    AX
        0x002d 00045 (main_a.go:15)     PCDATA  $0, $0
        0x002d 00045 (main_a.go:15)     MOVQ    AX, (CX)
        0x0030 00048 (main_a.go:16)     CALL    runtime.printlock(SB)
        0x0035 00053 (main_a.go:16)     PCDATA  $0, $1
        0x0035 00053 (main_a.go:16)     LEAQ    go.string."b defer: i = "(SB), AX
        0x003c 00060 (main_a.go:16)     PCDATA  $0, $0
        0x003c 00060 (main_a.go:16)     MOVQ    AX, (SP)
        0x0040 00064 (main_a.go:16)     MOVQ    $13, 8(SP)
        0x0049 00073 (main_a.go:16)     CALL    runtime.printstring(SB)
        0x004e 00078 (main_a.go:16)     PCDATA  $0, $1
        0x004e 00078 (main_a.go:16)     PCDATA  $1, $1
        0x004e 00078 (main_a.go:16)     MOVQ    "".&amp;i+40(SP), AX
        0x0053 00083 (main_a.go:16)     PCDATA  $0, $0
        0x0053 00083 (main_a.go:16)     MOVQ    (AX), AX
        0x0056 00086 (main_a.go:16)     MOVQ    AX, ""..autotmp_1+16(SP)
        0x005b 00091 (main_a.go:16)     MOVQ    AX, (SP)
        0x005f 00095 (main_a.go:16)     CALL    runtime.printint(SB)
        0x0064 00100 (main_a.go:16)     CALL    runtime.printnl(SB)
        0x0069 00105 (main_a.go:16)     CALL    runtime.printunlock(SB)
        0x006e 00110 (main_a.go:17)     MOVQ    24(SP), BP
        0x0073 00115 (main_a.go:17)     ADDQ    $32, SP
        0x0077 00119 (main_a.go:17)     RET
        0x0078 00120 (main_a.go:17)     NOP
        0x0078 00120 (main_a.go:14)     PCDATA  $1, $-1
        0x0078 00120 (main_a.go:14)     PCDATA  $0, $-2
        0x0078 00120 (main_a.go:14)     CALL    runtime.morestack_noctxt(SB)
        0x007d 00125 (main_a.go:14)     PCDATA  $0, $-1
        0x007d 00125 (main_a.go:14)     JMP     0
</pre></table></code></div></div><h2 id="参考">参考</h2><ol><li><a href="https://cloud.tencent.com/developer/article/1692904">Golang 汇编入门知识总结</a><li><a href="https://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html">汇编语言入门教程</a><li><a href="https://my.oschina.net/henrylee2cn/blog/505535">Golang中defer、return、返回值之间执行顺序的坑</a><li><a href="https://juejin.cn/post/6844903877033066509">彻底弄懂return和defer的微妙关系</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/golang/'>Golang</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/golang/" class="post-tag no-text-decoration" >Golang</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Golang defer知识点 - Ming&url=http://blog.huimingz.com/posts/golang-defer/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Golang defer知识点 - Ming&u=http://blog.huimingz.com/posts/golang-defer/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Golang defer知识点 - Ming&url=http://blog.huimingz.com/posts/golang-defer/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/git-note/">Git常用命令</a><li><a href="/posts/tools-are-productivity/">工具即生产力（收集）</a><li><a href="/posts/jekly-note/">Jekyll笔记</a><li><a href="/posts/latency-time/">计算机延迟（Latency time）</a><li><a href="/posts/domain-deriven-desgin-note/">领域驱动设计（笔记）</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/golang/">Golang</a> <a class="post-tag" href="/tags/other/">other</a> <a class="post-tag" href="/tags/architect/">architect</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/facility/">facility</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/jeklly/">jeklly</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/golang-test-setup-and-teardown/"><div class="card-body"> <span class="timeago small" > Feb 21, 2021 <i class="unloaded">2021-02-21T09:58:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Golang test中如何使用setUp和tearDown</h3><div class="text-muted small"><p> 在进行单元测试时，我们有些时候需要在执行前和执行后做一些工作，比如准备测试数据，测试结束后的测试数据清理。 包范围的准备和清理 在Golang中并没有直接提供setUp和tearDown，单我们可以利用 TestMain(m *testing.M) 来实现： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25...</p></div></div></a></div><div class="card"> <a href="/posts/golang-utf8-usage/"><div class="card-body"> <span class="timeago small" > Feb 10, 2021 <i class="unloaded">2021-02-10T18:50:06+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GolangでUTF-8の文字列を扱う</h3><div class="text-muted small"><p> 転載元：https://qiita.com/masakielastic/items/01a4fb691c572dd71a19 文字列を表示する package main func main() { str := "あいうえお" buf := []byte("あいうえお") runes := []rune("あいうえお") println(str) ...</p></div></div></a></div><div class="card"> <a href="/posts/golang-goproxy/"><div class="card-body"> <span class="timeago small" > Jul 26, 2021 <i class="unloaded">2021-07-26T22:22:10+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Golang Proxy设置</h3><div class="text-muted small"><p> 重置GOPROXY: 1 go env -w GOPROXY=https://proxy.golang.org,direct</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/jekly-note/" class="btn btn-outline-primary" prompt="Older"><p>Jekyll笔记</p></a> <a href="/posts/aliyun-oss-image-hosting-note/" class="btn btn-outline-primary" prompt="Newer"><p>使用阿里云OSS作为图床</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//huimingz.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Golang defer知识点'; this.page.url = 'http://blog.huimingz.com/posts/golang-defer/'; this.page.identifier = '/posts/golang-defer/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/huimingz12">huimingz</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/golang/">Golang</a> <a class="post-tag" href="/tags/other/">other</a> <a class="post-tag" href="/tags/architect/">architect</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/facility/">facility</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/jeklly/">jeklly</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://blog.huimingz.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
